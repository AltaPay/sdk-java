<?xml version='1.0' encoding='utf-8'?>
<!DOCTYPE project>
<project name="pensio_java_api" default="jar">
	<import file="build-common.xml"/>
	
	<property name="testUrl" value="http://cigateway.mars.pensio.com/" />
	
	<property name="xsdUrl" value="http://cigateway.mars.pensio.com/" />

		<property name="outputdirs" value="build,devbuild,output,dependencylib" />
	<property name="local_dependencies" value="" />
	<path id="CompileSource_classpath">
		<fileset dir="lib/" includes="*.jar" />
		<fileset dir="dependencylib/" includes="*.jar" />
	</path>
	<path id="CompileSource_source">
		<path path="src/"/>
		<path path="generated/"/>
	</path>
	<path id="CompileSourceDev_classpath">
		<fileset dir="devlib/" includes="*.jar" />
	</path>
	<path id="CompileSourceDev_source">
	    <path path="test/integration/"/>
	</path>

	<target name="CopyMetaInf">
		<copy todir="build/">
			<fileset dir="src/" includes="**/*.version" />
		</copy>
	</target>
	
	<target name="GenerateSource">
		<exec command="wget" failifexecutionfails="true">
			<arg value="${xsdUrl}APIResponse.xsd"/>
			<arg value="-O"/>
			<arg value="APIResponse.xsd"/>
		</exec>
		<exec command="xjc" failifexecutionfails="true">
			<arg value="-d"/>
			<arg value="generated/"/>
			<arg value="-p"/>
			<arg value="com.pensio.api.generated"/>
			<arg value="APIResponse.xsd"/>
		</exec>
	</target>	

	<target name="PensioRelease">
		<tstamp>
            <format property="pensio.release" pattern="yyyyMMdd" locale="en,GB"/>
        </tstamp>
	</target>

	<target name="PensioRevision">
		<!-- Calculate the revision -->
		<exec executable="sh" outputproperty="pensio.revision">
			<arg value="-c" />
			<arg value="svn info | grep 'Last Changed Rev: ' | sed 's/Last Changed Rev: //'" />
		</exec>
	</target>

	<target name="sdkVersion" depends="CopyMetaInf,PensioRelease">
		<echo file="build/META-INF/sdk.version">JavaSDK/${pensio.release}</echo>
	</target>
	
	<target name="jar" depends="sdkVersion,GenerateSource,CompileSource">

		
		<jar destfile="output/pensio_java_api.jar">
			<fileset dir="build">
				<include name="**/*"/>
			</fileset>
			<fileset dir="src">
				<include name="**/*.java"/>
			</fileset>
			<fileset dir="generated">
				<include name="**/*.java"/>
			</fileset>
		</jar>

		<copy todir="output/">
			<fileset dir="lib/" includes="*.jar" />	
		</copy>
	</target>
	
	<target name="DistZip" depends="PensioRelease,PensioRevision,jar">
		<zip destfile="dist/${ant.project.name}_${pensio.release}_r${pensio.revision}.zip">
			<zipfileset dir="output" includes="pensio_java_api.jar" prefix="lib/" />
			<zipfileset dir=".">
				<filename name="lib/*.jar"/>
			</zipfileset>
			<zipfileset dir="dependencylib/" prefix="lib/">
				<filename name="*.jar"/>
			</zipfileset>
			<zipfileset dir=".">
				<filename name="src/**/*.java"/>
			</zipfileset>
			<zipfileset dir="../PensioBaseLibrary/">
				<filename name="src/**/*.java"/>
			</zipfileset>
		</zip>
	</target>
	
	<target name="UnitTests" depends="sdkVersion,GenerateSource,CompileSource">
		<delete dir="output/unit_tests" />
		<mkdir dir="output/unit_tests" />
		
		<junit>
			<classpath>
				<pathelement path="build" />
				<pathelement path="devbuild" />
				<fileset dir="lib/" includes="*.jar" />
				<fileset dir="dependencylib/" includes="*.jar" />
				<fileset dir="devlib/" includes="*.jar" />
			</classpath>
			<formatter type="xml" />
			<batchtest todir="output/unit_tests">
				<fileset dir="test/unit/" includes="**/*Test.java" />
			</batchtest>
		</junit>
	</target>

	<target name="IntegrationTests" depends="sdkVersion,GenerateSource,CompileSource">
		<delete dir="output/integration_tests" />
		<mkdir dir="output/integration_tests" />
		<junit>
			<sysproperty key="pensio.TestUrl" value="${testUrl}" />
			<classpath>
				<pathelement path="build" />
				<pathelement path="devbuild" />
				<fileset dir="lib/" includes="*.jar" />
				<fileset dir="dependencylib/" includes="*.jar" />
				<fileset dir="devlib/" includes="*.jar" />
			</classpath>
			<formatter type="xml" />
			<batchtest todir="output/integration_tests">
				<fileset dir="test/integration/" includes="**/*Test.java" />
			</batchtest>
		</junit>
	</target>

</project>
